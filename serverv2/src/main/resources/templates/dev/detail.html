<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" >
<head th:include="include :: header"></head>
<head>
    <meta charset="utf-8">
    <title>设备详情</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
	<style type="text/css">
	body, html {width: 100%;height: 100%;overflow: hidden;margin:0;font-family:"微软雅黑";background-color: #cccccc;}
	#allmap{
		width: 49%;height: 100%;overflow: hidden;float: right;background-color: white;
	}
	._cont{
		width: 100%;height: 100%;overflow: hidden;margin:0;padding-top: 5px;
	}
	#_left{
			width: 69%;height: 55%;float: left;background-color: white;
	}
	#_alarm{
		width: 30%;height: 55%;float: right;background-color: white;
	}
	#_param{
		width: 49%;height: 100%;float: left;background-color: white;
	}
	.panel-content{
		background-color: white;
		margin-top: 10px;
	}
	.panel-body{
		padding-top: 10px;
	}
	._table{
		width: 100%;
		height: 90%;
		background-color: white;
	}
	._alarm_table{
		width: 100%;
		height: 45%;
	}
	</style>
	<script type="text/javascript" src="https://api.map.baidu.com/api?v=3.0&ak=zHxB5vhv7wqKIrVTkLm4dGpM57uL6NNg"></script>
</head>

<body>
<div class="_cont">
	<div id="_left">
		<div id="_param">
			<div class="_table">
				<table class="layui-table" lay-skin="line">
					<tr>
						<td>IMEI</td>
						<td class="_imei">867808042089837</td>
					</tr>
					<tr>
						<td>序列号</td>
						<td class="_eqptSn">867808042089837</td>
					</tr>
					<tr>
						<td>设备名称</td>
						<td class="_eqptName">867808042089837</td>
					</tr>
					<tr>
						<td>设备状态</td>
						<td class="_eqptStatus">0</td>
					</tr>
					<tr>
						<td>地址</td>
						<td class="_address">867808042089837</td>
					</tr>
				</table>
			</div>
		</div>
		
		<div id="allmap" >
			
		</div>
	</div>
	<div id="_alarm">
		<div class="layui-inline" style="width: 320px;"align="center">
		    <input type="text" class="layui-input" id="times" width="300px;">
		</div>
		
		<div class="panel-body" >
            <div class="panel-title">
                <span class="label pull-right layui-bg-blue">实时</span>
            </div>
            <div class="panel-content">
                <h1 class="no-margins">1234</h1>
                <small>当前分类总记录数</small>
            </div>
        </div>
        
        <div class="panel-body" >
            <div class="panel-title">
                <span class="label pull-right layui-bg-blue">实时</span>
            </div>
            <div class="panel-content">
                <h1 class="no-margins">1234</h1>
                <small>当前分类总记录数</small>
            </div>
        </div>
        
        <div class="panel-body" >
            <div class="panel-title">
                <span class="label pull-right layui-bg-blue">实时</span>
            </div>
            <div class="panel-content">
                <h1 class="no-margins">1234</h1>
                <small>当前分类总记录数</small>
            </div>
        </div>
        
        <div class="panel-body" >
            <div class="panel-title">
                <span class="label pull-right layui-bg-blue">实时</span>
            </div>
            <div class="panel-content">
                <h1 class="no-margins">1234</h1>
                <small>当前分类总记录数</small>
            </div>
        </div>
	</div>
	<div class="_alarm_table">
		<table class="layui-hide" id="currentTableId" lay-filter="currentTableFilter"></table>
	</div>
</div>
<div th:include="include::footer"></div>
<script>
var dataRow = window.parent.dataRow;
console.log(dataRow)
$("._imei").text(dataRow.imei);
$("._eqptSn").text(dataRow.eqptSn);
$("._eqptName").text(dataRow.eqptName);
$("._eqptStatus").text(dataRow.eqptStatus == 9000 ?'在线':'离线');
$("._address").text(dataRow.province + dataRow.city + dataRow.district + dataRow.address);
var map = new BMap.Map("allmap");    // 创建Map实例
map.centerAndZoom(new BMap.Point(113.261081,23.128689), 15);  // 初始化地图,设置中心点坐标和地图级别
//添加地图类型控件
map.addControl(new BMap.MapTypeControl({
	mapTypes:[
        BMAP_NORMAL_MAP,
        BMAP_HYBRID_MAP
    ]}));	  
//添加带有定位的导航控件
var navigationControl = new BMap.NavigationControl({
  // 靠左上角位置
  anchor: BMAP_ANCHOR_TOP_LEFT,
  // LARGE类型
  type: BMAP_NAVIGATION_CONTROL_LARGE,
  // 启用显示定位
  enableGeolocation: true
});
map.addControl(navigationControl);  
// 添加定位控件
var geolocationControl = new BMap.GeolocationControl();
geolocationControl.addEventListener("locationSuccess", function(e){
  // 定位成功事件
  var address = '';
  address += e.addressComponent.province;
  address += e.addressComponent.city;
  address += e.addressComponent.district;
  address += e.addressComponent.street;
  address += e.addressComponent.streetNumber;
  alert("当前定位地址为：" + address);
});
geolocationControl.addEventListener("locationError",function(e){
  // 定位失败事件
  alert(e.message);
});
map.addControl(geolocationControl);
map.enableScrollWheelZoom(true);//开启鼠标滚轮缩放
console.log(dataRow.latitude + "---------------》" +dataRow.longitude)
/* var point = new BMap.Point(dataRow.latitude,dataRow.longitude);
var marker = new BMap.Marker(point); */
var vectorMarker = new BMap.Marker(new BMap.Point(dataRow.latitude,dataRow.longitude), {
	  // 指定Marker的icon属性为Symbol
	  icon: new BMap.Symbol(BMap_Symbol_SHAPE_POINT, {
	    scale: 1.5,//图标缩放大小
	    fillColor: "orange",//填充颜色
	    fillOpacity: 0.8//填充透明度
	  })
	});
map.addOverlay(vectorMarker);
layui.use(['layer', 'echarts','laydate'], function () {
	var value = fun_day(-1).substring(0,10) + " - " +new Date().Format("yyyy-MM-dd");
    var $ = layui.jquery,
        layer = layui.layer,
        echarts = layui.echarts,
    	laydate = layui.laydate;
    var d = laydate.render({
        elem: '#times'
        //,type: 'datetime'
        ,range: true
        ,max : 'today'
        ,value: value//"2020-09-02 17:47:48 - 2020-09-09 17:47:48"
        ,btns: ['confirm']
        ,ready: function(date){
            $(".laydate-footer-btns").after('<span lay-type="_week" class="_week">最近七天</span>');
            $(".laydate-footer-btns").after('<span lay-type="_one_month" class="_one_month">最近一个月</span>');
            $(".laydate-footer-btns").after('<span lay-type="_three_month" class="_three_month">最近三个月</span>');
            var  _thisid=this.elem;
            $("._week").on('click',function(){
            	var date = new Date();
            	var t = fun_day(-7).substring(0,10) + " - " +  date.Format("yyyy-MM-dd");
            	_thisid.val(t);
            	$("#times").focus();
            	$(".laydate-btns-confirm").trigger('click');
            })
            $("._one_month").on('click',function(){
            	var date = new Date();
            	console.log(date.Format("yyyy-MM-dd"));
            	var t = fun_month(-1).substring(0,10) + " - " +  date.Format("yyyy-MM-dd");
            	_thisid.val(t);
            	$("#times").focus();
            	$(".laydate-btns-confirm").trigger('click');
            })
            $("._three_month").on('click',function(){
            	var date = new Date();
            	var t = fun_month(-3).substring(0,10) + " - " +  date.Format("yyyy-MM-dd");
            	_thisid.val(t);
            	$("#times").focus();
            	$(".laydate-btns-confirm").trigger('click');
				
            })
            
            $(".laydate-btns-clear").on('click',function(){
	        	_thisid.val(null);
	        	$("#times").focus();
	        	$(".laydate-btns-confirm").trigger('click');
    		})
        },done: function(value, date, endDate){
        	if(value.length != 0){
        		var arr = value.split(" - ");
                var e = {};
                e.startTime = $.trim(arr[0]);
                e.endTime = $.trim(arr[1]);
                //initEchartsDate(e);
        	}
          }
      });
	loadTable(jsonEntity);
});
var jsonEntity = {};
var dataRow;
var miniTab;
jsonEntity.eqptType = $.getUrlParam('eqptType');
function loadTable(jsonEntity){
	table.render({
        elem: '#currentTableId',
        url: getRootPath() + '/receive/alarm/info',
        headers: { "Authorization": authorization ,"dz-usr":authUser.uid},//通过请求头来发送token，放弃了通过cookie的发送方式
        where : jsonEntity,
        async : false,
        defaultToolbar: ['filter', 'exports', 'print', {
            title: '提示',
            layEvent: 'LAYTABLE_TIPS',
            icon: 'layui-icon-tips'
        }],
        cols: [[
            //{type: "checkbox"},
            {field: 'addTime',title: '告警时间', sort: true},
            {field: 'imei',title: 'imei', sort: true},
            {field: 'eqptAddr', title: '地址',
   			 templet : function(row) {
	   				if (typeof(row.eqptAdrr) == "undefined")
	   				{
	   					return row.province + row.city + row.district;
	   				}
					return row.province + row.city + row.district + row.eqptAdrr;
				}},
            {field: 'eqptName',  
             title: '名称'
			 },
			 {field: 'alarmMsg', 
				 width : '25%',
	          title: '告警内容',
	          align: 'center' ,
	          templet : function(row) {
	        	 if(typeof(row.alarmMsg) == 'undefined'){
	        		 return '';
	        	 }else{
	        		 var alarmInfo = JSON.parse(row.alarmMsg);
	    			 return _alarmIcon(alarmInfo);
	        	 }
			   }
			 },
            {field: 'alarmStatus',  title: '告警状态', sort: true,align: 'center',
				 templet : function(row) {//layui-icon-rss
	   				if (row.alarmStatus == 0)
	   				{
	   					return '未处理';
	   				}else{
	   					return '已处理';
	   				}
				}	 
            },
            {field: 'ctsPhone',title: '联系人电话', sort: true},
            {title: '操作', toolbar: '#currentTableBar', align: "center",width:'15%'}
        ]],
        limits: [5, 10, 20, 25, 50, 100],
        limit: 10,
        page: true,
        skin: 'line',
        done : function(res, curr, count) {
			currentPage = curr;
			table_Data = res.data;
			checkRender();
		}
    });
}
</script>
</body>

</html>