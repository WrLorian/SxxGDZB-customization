<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kiwihouse.dao.mapper.ReportedInfoMapper">

    <!--query-->
    <!--根据alarm_msg中的多个排序-->
    <select id="queryInfo" resultType="com.kiwihouse.dto.ReportedDto"
            parameterType="com.kiwihouse.vo.kiwihouse.ReportedQueryVo">
        select alarm_msg,ai.imei,alarm_status,alarm_type,ai.add_time,ai.eqpt_sn
        from alarm_info as ai
        inner join equipment as e on ai.eqpt_sn=e.eqpt_sn
        <where>
            <if test="adminId != null and adminId != ''">
                and e.admin_id in (select distinct admin_id from parent_admin where parent_id = #{adminId} or admin_id =
                #{adminId})
            </if>
            <if test="userId != null and userId != ''">
                and e.user_id = #{userId}
            </if>
            <if test="eqptSn != null and eqptSn != ''">
                and ai.eqpt_sn=#{eqptSn}
            </if>
            <if test="alarmType != null and alarmType != ''">
                and ai.alarm_type=#{alarmType}
            </if>
            <if test="endTime!=null and endTime!='' and startTime !=null and startTime!=''">
                and DATE_FORMAT(ai.add_time,'%Y-%m-%d') between #{startTime} and #{endTime}
            </if>
        </where>
    </select>
    <select id="queryInfoRow" resultType="java.lang.Integer"
            parameterType="com.kiwihouse.vo.kiwihouse.ReportedQueryVo">
        select count(*)
        from alarm_info as ai
        inner join equipment as e on ai.eqpt_sn=e.eqpt_sn
        <where>
            <if test="adminId != null and adminId != ''">
                and e.admin_id in (select distinct admin_id from parent_admin where parent_id = #{adminId} or admin_id =
                #{adminId})
            </if>
            <if test="eqptSn != null and eqptSn != ''">
                and ai.eqpt_sn=#{eqptSn}
            </if>
            <if test="alarmType != null and alarmType != ''">
                and ai.alarm_type=#{alarmType}
            </if>
            <if test="endTime!=null and endTime!='' and startTime !=null and startTime!=''">
                and DATE_FORMAT(ai.add_time,'%Y-%m-%d') between #{startTime} and #{endTime}
            </if>
        </where>
    </select>
    <select id="queryAlmInfo" resultType="com.kiwihouse.dto.AlarmEqptDto"
            parameterType="com.kiwihouse.vo.kiwihouse.AlmQueryVo">
        select * from (
        select t.alarm_id,t.alarm_msg,t.alarm_status,t.eqpt_sn,t.add_time,
        e.eqpt_type,e.user_id,e.site_id,e.eqpt_name,e.admin_id,e.eqpt_addr,
        u.user_name,u.phone as userPhone,
        c.cts_name,c.phone as ctsPhone,
        s.province,s.city,s.district,s.address
        from (
        select alarm_id,alarm_msg,alarm_status,eqpt_sn,add_time
        from alarm_info
        <where>
            alarm_type=2
            <if test="alarmStatus != null and alarmStatus != ''">
                and alarm_status =#{alarmStatus}
            </if>
        </where>
        )t
        left join equipment as e on t.eqpt_sn=e.eqpt_sn
        left join `user` as u on e.user_id=u.user_id
        left join contacts as c on e.user_id=c.user_id
        left join site as s on e.site_id=s.site_id
        where t.alarm_msg like '%2%' or t.alarm_msg like '%1%'
        )t1
        <where>
            <if test="adminId != null and adminId != ''">
                and t1.admin_id in (select distinct admin_id from parent_admin where parent_id = #{adminId} or admin_id
                = #{adminId})
            </if>
            <if test="eqptSn != null and eqptSn != ''">
                and eqpt_sn=#{eqptSn}
            </if>
            <if test="province != null and province != ''">
                and province=#{province}
            </if>
            <if test="city != null and city != ''">
                and city=#{city}
            </if>
            <if test="district != null and district != ''">
                and district=#{district}
            </if>
            <if test="address != null and address != ''">
                and address like CONCAT('%',#{address},'%')
            </if>
            <if test="userId != null and userId != ''">
                and user_id=#{userId}
            </if>
            <if test="endTime!=null and endTime!='' and startTime !=null and startTime!=''">
                and add_time between #{startTime} and #{endTime}
            </if>
        </where>
        order by add_time desc
    </select>

    <select id="queryPwr" resultType="com.kiwihouse.dto.FirePwrDto"
            parameterType="com.kiwihouse.vo.kiwihouse.QueryPwrVo">
        select pwr_msg,fp.eqpt_sn,fp.add_time
        from device.fire_pwr as fp
        inner join device.equipment as e on e.eqpt_sn=fp.eqpt_sn
        <where>
            <if test="adminId != null and adminId != ''">
                and e.admin_id in (select distinct admin_id from parent_admin where parent_id = #{adminId} or admin_id =
                #{adminId})
            </if>
            <if test="eqptSn != null and eqptSn != ''">
                and fp.eqpt_sn=#{eqptSn}
            </if>
            <if test="endTime!=null and endTime!='' and startTime !=null and startTime!=''">
                and fp.add_time between #{startTime} and #{endTime}
            </if>
        </where>
        order by add_time
    </select>
	
</mapper>