<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kiwihouse.mapper.MaintainMapper">

    <!--query-->
    <select id="queryInfo" resultType="com.kiwihouse.dto.MtInfoDto" parameterType="com.kiwihouse.vo.kiwihouse.MtInfoVo">
        select mt_id,mt_msg,mt_name,mt_phone,mt_status,mt.update_time,mt.eqpt_sn,
            e.eqpt_name,e.eqpt_type,e.site_id,e.admin_id,
            ai.alarm_id,ai.alarm_msg,ai.alarm_type,ai.add_time,
            s.province,s.city,s.district,s.address
            from maintain_info as mt
            left join alarm_info as ai on ai.alarm_id=mt.alarm_id
            left join equipment as e on e.eqpt_sn=mt.eqpt_sn
            left join site as s on e.site_id=s.site_id
        <where>
            <if test="adminId != null and adminId != ''">
                and e.admin_id in (select distinct admin_id from parent_admin where parent_id = #{adminId} or admin_id = #{adminId})
            </if>
            <if test="eqptSn != null and eqptSn != ''">
                and mt.eqpt_sn=#{eqptSn}
            </if>
            <if test="mtName != null and mtName != ''">
                and mt_name=#{mtName}
            </if>
            <if test="mtStatus != null and mtStatus != '' and mtStatus != 'noCancel'">
                and mt.mt_status=#{mtStatus}
            </if>
            <if test="mtStatus == 'noCancel'">
                and mt.mt_status != 2
            </if>
        </where>
        order by mt.update_time desc limit #{page},#{limit}
    </select>
    <select id="queryInfoRow" resultType="java.lang.Integer" parameterType="com.kiwihouse.vo.kiwihouse.EqptQueryVo">
        select count(*)
        from maintain_info as mt
        left join alarm_info as ai on ai.alarm_id=mt.alarm_id
        left join equipment as e on e.eqpt_sn=ai.eqpt_sn
        left join site as s on e.site_id=s.site_id
        <where>
            <if test="adminId != null and adminId != ''">
                and e.admin_id in (select distinct admin_id from parent_admin where parent_id = #{adminId} or admin_id = #{adminId})
            </if>
            <if test="eqptSn != null and eqptSn != ''">
                and mt.eqpt_sn=#{eqptSn}
            </if>
            <if test="mtName != null and mtName != ''">
                and mt_name=#{mtName}
            </if>
            <if test="mtStatus != null and mtStatus != '' and mtStatus != 'noCancel'">
                and mt.mt_status=#{mtStatus}
            </if>
            <if test="mtStatus == 'noCancel'">
                and mt.mt_status != 2
            </if>
        </where>
    </select>

    <select id="querySmokeInfo" resultType="com.kiwihouse.dto.MtSmokeInfoDto" parameterType="com.kiwihouse.vo.kiwihouse.MtInfoVo">
        select mt_id,mt_msg,mt_name,mt_phone,mt_status,mt.update_time,mt.eqpt_sn,
            e.eqpt_name,e.eqpt_type,e.site_id,e.admin_id,
            si.smoke_id,
            s.province,s.city,s.district,s.address
            from maintain_smoke as mt
            left join smoke_info as si on si.smoke_id=mt.smoke_id
            left join equipment as e on e.eqpt_sn=mt.eqpt_sn
            left join site as s on e.site_id=s.site_id
        <where>
            <if test="adminId != null and adminId != ''">
                and e.admin_id in (select distinct admin_id from parent_admin where parent_id = #{adminId} or admin_id = #{adminId})
            </if>
            <if test="eqptSn != null and eqptSn != ''">
                and mt.eqpt_sn=#{eqptSn}
            </if>
            <if test="mtName != null and mtName != ''">
                and mt_name=#{mtName}
            </if>
            <if test="mtStatus != null and mtStatus != '' and mtStatus != 'noCancel'">
                and mt.mt_status=#{mtStatus}
            </if>
            <if test="mtStatus == 'noCancel'">
                and mt.mt_status != 2
            </if>
        </where>
        order by mt.update_time desc limit #{page},#{limit}
    </select>
    <select id="querySmokeInfoRow" resultType="java.lang.Integer" parameterType="com.kiwihouse.vo.kiwihouse.EqptQueryVo">
        select count(*)
        from maintain_info as mt
        left join alarm_info as ai on ai.alarm_id=mt.alarm_id
        left join equipment as e on e.eqpt_sn=ai.eqpt_sn
        left join site as s on e.site_id=s.site_id
        <where>
            <if test="adminId != null and adminId != ''">
                and e.admin_id in (select distinct admin_id from parent_admin where parent_id = #{adminId} or admin_id = #{adminId})
            </if>
            <if test="eqptSn != null and eqptSn != ''">
                and mt.eqpt_sn=#{eqptSn}
            </if>
            <if test="mtName != null and mtName != ''">
                and mt_name=#{mtName}
            </if>
            <if test="mtStatus != null and mtStatus != '' and mtStatus != 'noCancel'">
                and mt.mt_status=#{mtStatus}
            </if>
            <if test="mtStatus == 'noCancel'">
                and mt.mt_status != 2
            </if>
        </where>
    </select>

    <select id="queryMtId" resultType="java.lang.String" parameterType="java.lang.String">
        select mt_id from maintain_info as mi
            left join equipment as e on mi.eqpt_sn=e.eqpt_sn
            where e.admin_id in (select distinct admin_id from parent_admin where parent_id = #{adminId} or admin_id = #{adminId})
    </select>

    <!--update-->
    <update id="updateAlmSta">
        update alarm_info set alarm_status=#{almSta} where alarm_id=#{alarmId}
    </update>
    <update id="updateSmokeAlmSta">
        update smoke_info set status=#{almSta} where smoke_id=#{alarmId}
    </update>

    <update id="updateMtInfo" parameterType="com.kiwihouse.vo.kiwihouse.MtUpdateVo">
        update maintain_info
        <set>
            <if test="mtName !=null and mtName !=''">
                mt_name=#{mtName},
            </if>
            <if test="mtPhone !=null and mtPhone !=''">
                mt_phone=#{mtPhone},
            </if>
            <if test="mtMsg !=null and mtMsg !=''">
                mt_msg=#{mtMsg},
            </if>
            <if test="mtStatus !=null and mtStatus !=''">
                mt_status=#{mtStatus},
            </if>
        </set>
        where mt_id=#{mtId}
    </update>
    <update id="updateMtSmokeInfo" parameterType="com.kiwihouse.vo.kiwihouse.MtUpdateVo">
        update maintain_smoke
        <set>
            <if test="mtName !=null and mtName !=''">
                mt_name=#{mtName},
            </if>
            <if test="mtPhone !=null and mtPhone !=''">
                mt_phone=#{mtPhone},
            </if>
            <if test="mtMsg !=null and mtMsg !=''">
                mt_msg=#{mtMsg},
            </if>
            <if test="mtStatus !=null and mtStatus !=''">
                mt_status=#{mtStatus},
            </if>
        </set>
        where mt_id=#{mtId}
    </update>

    <!--add-->
    <insert id="addInfo" parameterType="java.lang.String">
        insert into maintain_info(alarm_id,mt_status,update_time,eqpt_sn) values (#{alarmId},0,#{addTime},#{eqptSn});
    </insert>
    <insert id="addSmokeInfo" parameterType="java.lang.String">
        insert into maintain_smoke(smoke_id,mt_status,update_time,eqpt_sn) values (#{alarmId},0,#{addTime},#{eqptSn});
    </insert>


</mapper>